<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì—¬ê¸°ë¶€í„° - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/community.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/js/community.js"></script>
  </head>
  <body>
    <!-- Header -->
    <div th:replace="header :: header"></div>

    <section class="senior-community-section">
      <!-- ìƒë‹¨ ì»¤ë®¤ë‹ˆí‹° ì •ë³´ í—¤ë” -->
      <div class="community-header">
        <div class="container">
          <div class="community-info-card">
            <div class="community-banner">
              <img
                src="/images/travel-banner.jpg"
                alt="ì»¤ë®¤ë‹ˆí‹° ë°°ë„ˆ"
                class="banner-image"
              />
              <div class="banner-overlay">
                <h1 class="community-title">
                  ì¤‘ë…„ ì—¬ì„±ë“¤ì˜ ì†Œë°•í•œ êµ­ë‚´ ì—¬í–‰ ê¸°ë¡
                </h1>
                <p class="community-subtitle">í•¨ê»˜í•˜ëŠ” ì¦ê±°ìš´ ì—¬í–‰ ì´ì•¼ê¸°</p>
              </div>
            </div>

            <div class="community-meta">
              <div class="meta-item">
                <span class="meta-icon">ğŸ‘¥</span>
                <span class="meta-label">ë©¤ë²„</span>
                <span class="meta-value">16ëª…</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon">ğŸ“</span>
                <span class="meta-label">ì§€ì—­</span>
                <span class="meta-value">ì„œìš¸</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon">ğŸ“…</span>
                <span class="meta-label">ì¼ì •</span>
                <span class="meta-value">2024.11.30~12.10</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon">ğŸ‘©</span>
                <span class="meta-label">ëŒ€ìƒ</span>
                <span class="meta-value">ì—¬ì„±ë§Œ (40~60ëŒ€)</span>
              </div>
            </div>

            <div class="community-actions">
              <button class="btn-primary btn-large">
                <span class="btn-icon">ğŸ‘¥</span>
                ë©¤ë²„ ë³´ê¸°
              </button>
              <button class="btn-secondary btn-large">
                <span class="btn-icon">âš™ï¸</span>
                ì„¤ì •
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
      <div class="container">
        <div class="main-layout">
          <!-- ì™¼ìª½: ì‚¬ì´ë“œë°” -->
          <aside class="sidebar">
            <!-- ì»¤ë®¤ë‹ˆí‹° ìƒì„¸ ì •ë³´ -->
            <div class="sidebar-card">
              <h3 class="card-title">
                <span class="title-icon">â„¹ï¸</span>
                ëª¨ì„ ìƒì„¸ ì •ë³´
              </h3>
              <div class="info-list">
                <div class="info-item">
                  <span class="info-label">ëª¨ì„ ì´ë¦„</span>
                  <span class="info-value"
                    >ì¤‘ë…„ ì—¬ì„±ë“¤ì˜ ì†Œë°•í•œ êµ­ë‚´ ì—¬í–‰ ê¸°ë¡</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">ëª¨ì„ ì„±ê²©</span>
                  <span class="info-value">êµ­ë‚´ì—¬í–‰</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ìŒì„± ì±„íŒ…</span>
                  <span class="info-value badge-success">ì‚¬ìš©</span>
                </div>
              </div>

              <div class="description-box">
                <h4>ëª¨ì„ ì†Œê°œ</h4>
                <p>
                  ì¹œê·¼í•˜ê³  ììœ ë¡œìš´ ë¶„ìœ„ê¸°ë¡œ 30ëŒ€ ì¤‘ë°˜ë¶€í„° 60ëŒ€ ì¤‘í›„ë°˜ê¹Œì§€ì˜
                  ë‹¤ì–‘í•œ ì—°ë ¹ëŒ€ê°€ í•¨ê»˜í•˜ëŠ” ëª¨ì„ì…ë‹ˆë‹¤. êµ­ë‚´ì˜ ë§›ìˆëŠ” ìŒì‹ë“¤ì„
                  ì¦ê¸°ê³  ì„œë¡œ ì¢‹ì€ ì •ë³´ë¥¼ ë‚˜ëˆ„ë©° ì¹œëª©ì„ ë„ëª¨í•˜ëŠ” ê²ƒì´
                  ëª©í‘œì…ë‹ˆë‹¤.
                </p>
              </div>
            </div>

            <!-- ë©¤ë²„ ëª©ë¡ -->
            <div class="sidebar-card">
              <div class="card-header-flex">
                <h3 class="card-title">
                  <span class="title-icon">ğŸ‘¥</span>
                  ëª¨ì„ ë©¤ë²„ (<span id="sidebarMemCount">0</span>ëª…)
                </h3>
                <button class="btn-text" id="viewAllMembers">ì „ì²´ë³´ê¸°</button>
              </div>

              <!-- ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆë§Œ ë‘ê³  JSë¡œ ì±„ì›€ -->
              <div class="member-preview" id="memberPreview"></div>
            </div>

            <!-- ë©¤ë²„ ëª©ë¡ -->
            <!-- <div class="sidebar-card">
              <div class="card-header-flex">
                <h3 class="card-title">
                  <span class="title-icon">ğŸ‘¥</span>
                  ëª¨ì„ ë©¤ë²„ (16ëª…)
                </h3>
                <button class="btn-text" id="viewAllMembers">ì „ì²´ë³´ê¸°</button>
              </div>

              <div class="member-preview">
                <div class="member-item">
                  <div class="member-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="ë©¤ë²„"
                      class="avatar-img"
                    />
                    <span class="member-status online"></span>
                  </div>
                  <div class="member-info">
                    <span class="member-name">ë©¤ë²„ë‹‰ë„¤ì„1</span>
                    <span class="member-role">ë¦¬ë”</span>
                  </div>
                </div>

                <div class="member-item">
                  <div class="member-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="ë©¤ë²„"
                      class="avatar-img"
                    />
                    <span class="member-status online"></span>
                  </div>
                  <div class="member-info">
                    <span class="member-name">ë©¤ë²„ë‹‰ë„¤ì„2</span>
                    <span class="member-role">ë©¤ë²„</span>
                  </div>
                </div>

                <div class="member-item">
                  <div class="member-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="ë©¤ë²„"
                      class="avatar-img"
                    />
                    <span class="member-status"></span>
                  </div>
                  <div class="member-info">
                    <span class="member-name">ë©¤ë²„ë‹‰ë„¤ì„3</span>
                    <span class="member-role">ë©¤ë²„</span>
                  </div>
                </div>
              </div>
            </div> -->

            <!-- ë¹ ë¥¸ ë§í¬ -->
            <div class="sidebar-card">
              <h3 class="card-title">
                <span class="title-icon">ğŸ”—</span>
                ë¹ ë¥¸ ë©”ë‰´
              </h3>
              <div class="quick-links">
                <a href="#" class="quick-link-item">
                  <span class="link-icon">ğŸ“‹</span>
                  <span class="link-text">ê³µì§€ì‚¬í•­</span>
                </a>
                <a href="#" class="quick-link-item">
                  <span class="link-icon">ğŸ“¸</span>
                  <span class="link-text">ì‚¬ì§„ì²©</span>
                </a>
                <a href="#" class="quick-link-item">
                  <span class="link-icon">ğŸ“…</span>
                  <span class="link-text">ì¼ì •ê´€ë¦¬</span>
                </a>
                <a href="#" class="quick-link-item">
                  <span class="link-icon">ğŸ’¬</span>
                  <span class="link-text">ì±„íŒ…ë°©</span>
                </a>
              </div>
            </div>
          </aside>
          <!-- ì˜¤ë¥¸ìª½: ê²Œì‹œê¸€ ì˜ì—­ -->
          <div class="posts-section">
            <!-- ê²Œì‹œê¸€ ì‘ì„± ì¹´ë“œ -->
            <div class="write-post-card">
              <div class="card-header">
                <h3>ìƒˆ ê¸€ ì‘ì„±</h3>
                <div class="post-count">ì´ 16ê°œì˜ ê¸€</div>
              </div>

              <div class="write-form">
                <div class="author-info">
                  <div class="author-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="í”„ë¡œí•„"
                      class="avatar-img"
                    />
                  </div>
                  <span class="author-name" th:text="${username != null ? username : 'ì‚¬ìš©ìë‹˜'}">í˜„ì¬ë¡œê·¸ì¸ì‚¬ëŒ</span>
                  
                </div>

                <div class="write-content">
                  <textarea
                    class="write-textarea"
                    placeholder="ì—¬í–‰ í›„ê¸°ë‚˜ ì¶”ì²œ ì¥ì†Œë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”! ì‚¬ì§„ë„ í•¨ê»˜ ì˜¬ë ¤ì£¼ì‹œë©´ ë” ì¢‹ì•„ìš” ğŸ˜Š"
                  ></textarea>

                  <!-- âœ… ì¸ë„¤ì¼ í”„ë¦¬ë·°ê°€ ë‚˜ì˜¬ ì˜ì—­ -->
                 <div class="write-photo-preview" id="photoPreview"></div>

                  <div class="write-toolbar">
                    <div class="toolbar-left">
                      <button class="toolbar-btn" id="btnPhoto" title="ì‚¬ì§„ ì²¨ë¶€">
                        <span class="btn-icon">ğŸ“·</span>
                        <span class="btn-text">ì‚¬ì§„</span>
                      </button>
                    </div>
                    <button class="btn-post-submit">ê²Œì‹œí•˜ê¸°</button>
                  </div>
                </div>
                <!-- âœ… ìˆ¨ê²¨ì§„ ì´ë¯¸ì§€ ì„ íƒ input -->
                <input id="photoInput" type="file" accept="image/*" multiple hidden>
              </div>
            </div>

            <!-- ì •ë ¬ ì˜µì…˜ -->
            <div class="sort-tabs">
              <button class="sort-tab active" data-sort="latest">ìµœì‹ ìˆœ</button>
              <button class="sort-tab" data-sort="popular">ì¸ê¸°ìˆœ</button>
              <button class="sort-tab" data-sort="oldest">ì˜¤ë˜ëœìˆœ</button>
            </div>

            <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
            <div class="posts-list" id="postsList"></div>

            <!-- ë¹„ì—ˆì„ ë•Œ í‘œì‹œ -->
            <div id="postsEmpty" style="display:none; padding:16px; color:#777;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>

            <!-- ë¡œë”© í‘œì‹œ(ì„ íƒ) -->
            <div id="postsLoading" style="display:none; padding:16px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

            <!-- ì¹´ë“œ í…œí”Œë¦¿ -->
            <template id="postCardTpl">
              <article class="post-card">
                <div class="post-header">
                  <div class="author-info">
                    <div class="author-avatar">
                      <img src="/images/default-avatar.png" alt="í”„ë¡œí•„" class="avatar-img" />
                    </div>
                    <div class="author-details">
                      <span class="author-name"></span>
                      <span class="post-time"></span>
                    </div>
                  </div>
                  <button class="post-menu-btn">â‹¯</button>
                </div>

                <div class="post-content">
                  <p class="post-text"></p>
                  <div class="post-images" hidden>
                    <div class="image-grid"></div>
                  </div>
                </div>

                <div class="post-actions">
                  <button class="action-btn like-btn" data-liked="false">
                    <span class="action-icon">â¤ï¸</span>
                    <span class="action-text">ì¢‹ì•„ìš” 0</span>
                  </button>
                  <button class="action-btn comment-btn">
                    <span class="action-icon">ğŸ’¬</span>
                    <span class="action-text">ëŒ“ê¸€ 0</span>
                  </button>
                  <button class="action-btn share-btn">
                    <span class="action-icon">ğŸ“¤</span>
                    <span class="action-text">ê³µìœ </span>
                  </button>
                </div>
              </article>
            </template>

        

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div class="pagination">
              <button class="page-btn prev" disabled>ì´ì „</button>
              <button class="page-btn active">1</button>
              <button class="page-btn">2</button>
              <button class="page-btn">3</button>
              <button class="page-btn next">ë‹¤ìŒ</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ëª¨ë‹¬ë“¤ (ê¸°ì¡´ ëª¨ë‹¬ êµ¬ì¡° ìœ ì§€) -->
    <div id="memberListModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>ì „ì²´ ë©¤ë²„</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <!-- ê¸°ì¡´ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ ë‚´ìš© -->
        </div>
      </div>
    </div>

    <!-- ì´ë¯¸ì§€ ë¼ì´íŠ¸ë°•ìŠ¤ -->
    <div id="imageLightbox" class="lb" hidden>
      <div class="lb-backdrop"></div>
      <div class="lb-dialog">
        <button class="lb-close" aria-label="ë‹«ê¸°">Ã—</button>
        <button class="lb-prev"  aria-label="ì´ì „">â€¹</button>
        <img id="lbImage" alt="ì²¨ë¶€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
        <button class="lb-next"  aria-label="ë‹¤ìŒ">â€º</button>
        <div class="lb-counter"></div>
      </div>
    </div>

    <!-- Footer -->
    <div th:replace="footer :: footer"></div>
  </body>
  <script th:inline="javascript">
  window.currentUser = {
    username: /*[[${username}]]*/ ""
  };
  /* ===== ì„¤ì •: ì—”ë“œí¬ì¸íŠ¸ë§Œ ë§ì¶”ë©´ ë¨ ===== */
const POSTS_ENDPOINT = '/community/all/posts'; // ì˜ˆ: GET /community/posts -> ë°°ì—´ ë˜ëŠ” {content:[...]}

/* ===== ìœ í‹¸ ===== */
const isArr = Array.isArray;
function normalizeList(v) {
  if (v == null) return [];
  if (isArr(v)) return v.filter(Boolean);
  if (typeof v === 'string') {
    const s = v.trim();
    if (!s) return [];
    try { // JSON ë¬¸ìì—´(["a","b"]) ê°€ëŠ¥ì„±
      if ((s.startsWith('[') && s.endsWith(']')) || (s.startsWith('"') && s.endsWith('"'))) {
        return normalizeList(JSON.parse(s));
      }
    } catch(_) {}
    return s.split(',').map(x => x.trim()).filter(Boolean); // ì½¤ë§ˆ êµ¬ë¶„
  }
  return [];
}
function timeAgo(iso) {
  if (!iso) return '';
  const now = new Date(), then = new Date(iso);
  const sec = Math.max(0, (now - then) / 1000);
  if (sec < 60) return 'ë°©ê¸ˆ ì „';
  const m = Math.floor(sec/60);   if (m < 60) return `${m}ë¶„ ì „`;
  const h = Math.floor(m/60);     if (h < 24) return `${h}ì‹œê°„ ì „`;
  const d = Math.floor(h/24);     if (d < 7) return `${d}ì¼ ì „`;
  const w = Math.floor(d/7);      if (w < 5) return `${w}ì£¼ ì „`;
  const mo = Math.floor(d/30);    if (mo < 12) return `${mo}ë‹¬ ì „`;
  const y = Math.floor(d/365);    return `${y}ë…„ ì „`;
}
// ë°±ì—”ë“œ í•„ë“œëª… ë‹¤ë¥¼ ë•Œ ëŒ€ì‘(ì›í•˜ëŠ”ëŒ€ë¡œ ìˆ˜ì • ê°€ëŠ¥)
function adaptPost(p) {
  return {
    id:           p.id ?? p.postId ?? p.post_id,
    authorName:   p.username,
    avatarUrl:    p.avatarUrl ?? p.avatar_url ?? '/images/default-avatar.png',
    content:      p.content ?? p.postContent ?? p.text ?? '',
    pictures:     p.pictures ?? p.images ?? p.picturesJson ?? p.picturesCsv,
    likeCount:    p.likesCount,
    commentCount: p.commentCount ?? p.comment_cnt ?? 0,
    liked:        !!(p.liked ?? p.isLiked),
    createdAt:    p.createdAt ?? p.reg_dt ?? p.created_at
  };
}

/* ===== ë Œë” ===== */
function renderImages(root, pictures) {
  const pics = normalizeList(pictures);
  const wrap = root.querySelector('.post-images');
  const grid = wrap.querySelector('.image-grid');
  grid.innerHTML = '';
  wrap.hidden = !pics.length;
  if (!pics.length) return;

  // âœ… ì´ ê²Œì‹œê¸€ì˜ ì „ì²´ ì´ë¯¸ì§€ ëª©ë¡ì„ ì»¨í…Œì´ë„ˆì— ë³´ê´€
  wrap.dataset.urls = JSON.stringify(pics);

  pics.slice(0, 9).forEach((src, i) => {
    const item = document.createElement('div');
    item.className = 'image-item';
    const img = document.createElement('img');
    img.className = 'post-img';
    img.src = String(src).trim();
    img.alt = 'ì—¬í–‰ ì‚¬ì§„';
    img.loading = 'lazy';
    img.dataset.idx = i;                 // âœ… í´ë¦­ ì‹œ ì‹œì‘ ì¸ë±ìŠ¤
    item.appendChild(img);

    if (i === 8 && pics.length > 9) {    // +N ì˜¤ë²„ë ˆì´(ì„ íƒ)
      const overlay = document.createElement('div');
      overlay.className = 'more-overlay';
      overlay.textContent = `+${pics.length - 9}`;
      item.appendChild(overlay);
    }
    grid.appendChild(item);
  });
}

function renderPostCard(post) {
  console.log("aaaa");
  const tpl = document.getElementById('postCardTpl');
  const node = tpl.content.firstElementChild.cloneNode(true);

  // header
  node.querySelector('.author-name').textContent = post.authorName || 'ìµëª…';
  node.querySelector('.post-time').textContent = timeAgo(post.createdAt);
  node.querySelector('.author-avatar img').src = post.avatarUrl || '/images/default-avatar.png';

  // content
  node.querySelector('.post-text').textContent = post.content || '';
  node.dataset.postId = post.id;     // <article class="post-card" data-post-id="...">
  renderImages(node, post.pictures);

  // actions
  const likeBtn = node.querySelector('.like-btn');
  const likeText = node.querySelector('.like-btn .action-text');
  const commentText = node.querySelector('.comment-btn .action-text');

  likeBtn.dataset.count = String(post.likeCount);
// commentBtn.dataset.count = String(post.commentCount);

likeBtn.dataset.liked = String(!!post.liked);

  likeText.textContent = `ì¢‹ì•„ìš” ${post.likeCount ?? 0}`;
  commentText.textContent = `ëŒ“ê¸€ ${post.commentCount ?? 0}`;

  // createdAt ë¬¸ìì—´ -> msë¡œ
const createdIso = (post.createdAt && typeof post.createdAt === 'string' && post.createdAt[10] === ' ')
  ? post.createdAt.replace(' ', 'T') : post.createdAt;
const createdMs = toMillis(createdIso);

node.querySelector('.post-time').textContent = timeAgo(createdIso);
node.dataset.created = String(createdMs);   // âœ… ì •ë ¬ìš© í‚¤ ì €ì¥

// âœ… ì„œë²„ì—ì„œ ì‚¬ìš©ìë³„ ì¢‹ì•„ìš” ìƒíƒœ/ìµœì‹  ì¹´ìš´íŠ¸ ì¡°íšŒí•´ ë®ì–´ì“°ê¸°
  hydrateLikeState(node, post.id);

  return node;
}

function applyLikeDesign(cardEl) {
  const btn  = cardEl.querySelector('.like-btn');
  if (!btn) return;

  const text = btn.querySelector('.action-text');

  // UI
  btn.classList.toggleClass('liked', nextLiked)
      .attr('aria-pressed', String(nextLiked));

  if (text) text.textContent = `ì¢‹ì•„ìš” ${count}`;
  btn.classList.toggle('liked', !!liked);
  btn.setAttribute('aria-pressed', String(!!liked));
}

function hydrateLikeState(cardEl, postId) {
  const payload = {
    username: window.currentUser.username,
    postId: postId
  };

  $.ajax({
    url: "/community/post/likeInfo",     // â† ë„¤ ì—”ë“œí¬ì¸íŠ¸
    type: "POST",
    data: JSON.stringify(payload),
    contentType: "application/json",
    success: function (resp) {
      if(resp){
        console.log("resp >>> " + resp);
         const btn  = cardEl.querySelector('.like-btn');
         const $btn = $(btn);
          // UI
          $btn.toggleClass('liked', resp)
        .attr('aria-pressed', String(resp));
        btn.dataset.liked = String(resp);
          // addHeartAnimation($btn);
      }
    },
    error: function (req, status, err) {
      console.error("ì¢‹ì•„ìš” ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:", err);
      // ì‹¤íŒ¨ ì‹œì—” ì´ˆê¸°ê°’(ê²Œì‹œê¸€ ëª©ë¡ì˜ ê°’) ìœ ì§€
    }
  });
}

function renderPosts(rows) {
  const listEl = document.getElementById('postsList');
  const emptyEl = document.getElementById('postsEmpty');
  listEl.innerHTML = '';

  if (!rows || !rows.length) {
    emptyEl.style.display = 'block';
    return;
  }
  emptyEl.style.display = 'none';

  const frag = document.createDocumentFragment();
  rows.forEach(raw => frag.appendChild(renderPostCard(adaptPost(raw))));
  listEl.appendChild(frag);
}

/* ===== ë¡œë”©/í˜¸ì¶œ ===== */
function setLoading(on) {
  document.getElementById('postsLoading').style.display = on ? 'block' : 'none';
}

async function loadPosts() {
  setLoading(true);
  const groupId = '1f2d3c4b-5a6e-4f80-9123-456789abcdef';
  try {
    const payload = {
      groupId: groupId,
    };

   const res = await fetch(POSTS_ENDPOINT, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify(payload)
  });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    // ë°°ì—´ ë˜ëŠ” í˜ì´ì§€ ê°ì²´(content ë°°ì—´) ëŒ€ì‘
    const rows = Array.isArray(data) ? data : (data.content || []);
    // âœ… ìµœì‹ ìˆœ(ë‚´ë¦¼ì°¨ìˆœ) ì •ë ¬: createdAt / created_at / reg_dt ìš°ì„  ì‚¬ìš©
    const sorted = [...rows].sort((a, b) => {
      const aT = toMillis(a.createdAt ?? a.created_at ?? a.reg_dt);
      const bT = toMillis(b.createdAt ?? b.created_at ?? b.reg_dt);
      return bT - aT;
    });
    console.log("posts >>> " + JSON.stringify(data));
    renderPosts(sorted);
  } catch (e) {
    console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', e);
    const emptyEl = document.getElementById('postsEmpty');
    emptyEl.textContent = 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
    emptyEl.style.display = 'block';
  } finally {
    setLoading(false);
  }
}

document.addEventListener('DOMContentLoaded', loadPosts);

(function(){
  const lb = document.getElementById('imageLightbox');
  const imgEl = lb.querySelector('#lbImage');
  const counterEl = lb.querySelector('.lb-counter');
  const btnClose = lb.querySelector('.lb-close');
  const btnPrev  = lb.querySelector('.lb-prev');
  const btnNext  = lb.querySelector('.lb-next');
  const backdrop = lb.querySelector('.lb-backdrop');

  let urls = [];
  let idx = 0;

  function refresh() {
    imgEl.src = urls[idx] || '';
    counterEl.textContent = `${idx+1}/${urls.length}`;
    const many = urls.length > 1;
    btnPrev.style.display = many ? 'flex' : 'none';
    btnNext.style.display = many ? 'flex' : 'none';
    counterEl.style.display = many ? 'block' : 'none';
  }

  function openLightbox(arr, startIdx){
    urls = Array.isArray(arr) ? arr : [];
    idx = Math.max(0, Math.min(startIdx|0, urls.length-1));
    if (!urls.length) return;
    refresh();
    lb.hidden = false;
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox(){
    lb.hidden = true;
    document.body.style.overflow = '';
    urls = []; idx = 0; imgEl.removeAttribute('src');
  }

  function showNext(delta){
    if (!urls.length) return;
    idx = (idx + delta + urls.length) % urls.length;
    refresh();
  }

  // ë²„íŠ¼/ë°±ë“œë¡­/í‚¤ë³´ë“œ
  btnClose.addEventListener('click', closeLightbox);
  backdrop.addEventListener('click', closeLightbox);
  btnPrev .addEventListener('click', () => showNext(-1));
  btnNext .addEventListener('click', () => showNext(+1));
  document.addEventListener('keydown', (e)=>{
    if (lb.hidden) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft')  showNext(-1);
    if (e.key === 'ArrowRight') showNext(+1);
  });

  // âœ… ë¸ë¦¬ê²Œì´ì…˜: ì–´ë–¤ ê²Œì‹œê¸€ì˜ ì¸ë„¤ì¼ì´ë“  í´ë¦­ ì‹œ ì—´ê¸°
  document.addEventListener('click', (e)=>{
    const img = e.target.closest('.post-images .post-img');
    if (!img) return;
    const wrap = img.closest('.post-images');
    let arr = [];
    try { arr = JSON.parse(wrap.dataset.urls || '[]'); } catch(_) {
      arr = Array.from(wrap.querySelectorAll('.post-img')).map(x=>x.src);
    }
    const startIdx = parseInt(img.dataset.idx || '0', 10);
    openLightbox(arr, startIdx);
  });
})();
</script>
</html>
