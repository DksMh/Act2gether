<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>여기부터 - 커뮤니티</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/community.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/js/community.js"></script>
  </head>
  <body>
    <!-- Header -->
    <div th:replace="header :: header"></div>

    <section class="senior-community-section">
      <!-- 상단 커뮤니티 정보 헤더 -->
      <div class="community-header">
        <div class="container">
          <div class="community-info-card">
            <div class="community-banner">
              <img
                src="/images/travel-banner.jpg"
                alt="커뮤니티 배너"
                class="banner-image"
              />
              <div class="banner-overlay">
                <h1 class="community-title">
                  중년 여성들의 소박한 국내 여행 기록
                </h1>
                <p class="community-subtitle">함께하는 즐거운 여행 이야기</p>
              </div>
            </div>

            <div class="community-meta">
              <div class="meta-item">
                <span class="meta-icon">👥</span>
                <span class="meta-label">멤버</span>
                <span class="meta-value">16명</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon">📍</span>
                <span class="meta-label">지역</span>
                <span class="meta-value">서울</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon">📅</span>
                <span class="meta-label">일정</span>
                <span class="meta-value">2024.11.30~12.10</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon">👩</span>
                <span class="meta-label">대상</span>
                <span class="meta-value">여성만 (40~60대)</span>
              </div>
            </div>

            <div class="community-actions">
              <button class="btn-primary btn-large">
                <span class="btn-icon">👥</span>
                멤버 보기
              </button>
              <button class="btn-secondary btn-large">
                <span class="btn-icon">⚙️</span>
                설정
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 메인 컨텐츠 영역 -->
      <div class="container">
        <div class="main-layout">
          <!-- 왼쪽: 사이드바 -->
          <aside class="sidebar">
            <!-- 커뮤니티 상세 정보 -->
            <div class="sidebar-card">
              <h3 class="card-title">
                <span class="title-icon">ℹ️</span>
                모임 상세 정보
              </h3>
              <div class="info-list">
                <div class="info-item">
                  <span class="info-label">모임 이름</span>
                  <span class="info-value"
                    >중년 여성들의 소박한 국내 여행 기록</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">모임 성격</span>
                  <span class="info-value">국내여행</span>
                </div>
                <div class="info-item">
                  <span class="info-label">음성 채팅</span>
                  <span class="info-value badge-success">사용</span>
                </div>
              </div>

              <div class="description-box">
                <h4>모임 소개</h4>
                <p>
                  친근하고 자유로운 분위기로 30대 중반부터 60대 중후반까지의
                  다양한 연령대가 함께하는 모임입니다. 국내의 맛있는 음식들을
                  즐기고 서로 좋은 정보를 나누며 친목을 도모하는 것이
                  목표입니다.
                </p>
              </div>
            </div>

            <!-- 멤버 목록 -->
            <div class="sidebar-card">
              <div class="card-header-flex">
                <h3 class="card-title">
                  <span class="title-icon">👥</span>
                  모임 멤버 (<span id="sidebarMemCount">0</span>명)
                </h3>
                <button class="btn-text" id="viewAllMembers">전체보기</button>
              </div>

              <!-- 미리보기 컨테이너만 두고 JS로 채움 -->
              <div class="member-preview" id="memberPreview"></div>
            </div>

            <!-- 멤버 목록 -->
            <!-- <div class="sidebar-card">
              <div class="card-header-flex">
                <h3 class="card-title">
                  <span class="title-icon">👥</span>
                  모임 멤버 (16명)
                </h3>
                <button class="btn-text" id="viewAllMembers">전체보기</button>
              </div>

              <div class="member-preview">
                <div class="member-item">
                  <div class="member-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="멤버"
                      class="avatar-img"
                    />
                    <span class="member-status online"></span>
                  </div>
                  <div class="member-info">
                    <span class="member-name">멤버닉네임1</span>
                    <span class="member-role">리더</span>
                  </div>
                </div>

                <div class="member-item">
                  <div class="member-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="멤버"
                      class="avatar-img"
                    />
                    <span class="member-status online"></span>
                  </div>
                  <div class="member-info">
                    <span class="member-name">멤버닉네임2</span>
                    <span class="member-role">멤버</span>
                  </div>
                </div>

                <div class="member-item">
                  <div class="member-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="멤버"
                      class="avatar-img"
                    />
                    <span class="member-status"></span>
                  </div>
                  <div class="member-info">
                    <span class="member-name">멤버닉네임3</span>
                    <span class="member-role">멤버</span>
                  </div>
                </div>
              </div>
            </div> -->

            <!-- 빠른 링크 -->
            <div class="sidebar-card">
              <h3 class="card-title">
                <span class="title-icon">🔗</span>
                빠른 메뉴
              </h3>
              <div class="quick-links">
                <a href="#" class="quick-link-item">
                  <span class="link-icon">📋</span>
                  <span class="link-text">공지사항</span>
                </a>
                <a href="#" class="quick-link-item">
                  <span class="link-icon">📸</span>
                  <span class="link-text">사진첩</span>
                </a>
                <a href="#" class="quick-link-item">
                  <span class="link-icon">📅</span>
                  <span class="link-text">일정관리</span>
                </a>
                <a href="#" class="quick-link-item">
                  <span class="link-icon">💬</span>
                  <span class="link-text">채팅방</span>
                </a>
              </div>
            </div>
          </aside>
          <!-- 오른쪽: 게시글 영역 -->
          <div class="posts-section">
            <!-- 게시글 작성 카드 -->
            <div class="write-post-card">
              <div class="card-header">
                <h3>새 글 작성</h3>
                <div class="post-count">총 16개의 글</div>
              </div>

              <div class="write-form">
                <div class="author-info">
                  <div class="author-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="프로필"
                      class="avatar-img"
                    />
                  </div>
                  <span class="author-name" th:text="${username != null ? username : '사용자님'}">현재로그인사람</span>
                  
                </div>

                <div class="write-content">
                  <textarea
                    class="write-textarea"
                    placeholder="여행 후기나 추천 장소를 공유해주세요! 사진도 함께 올려주시면 더 좋아요 😊"
                  ></textarea>

                  <div class="write-toolbar">
                    <div class="toolbar-left">
                      <button class="toolbar-btn" title="사진 첨부">
                        <span class="btn-icon">📷</span>
                        <span class="btn-text">사진</span>
                      </button>
                      <button class="toolbar-btn" title="파일 첨부">
                        <span class="btn-icon">📁</span>
                        <span class="btn-text">파일</span>
                      </button>
                      <button class="toolbar-btn" title="위치 태그">
                        <span class="btn-icon">📍</span>
                        <span class="btn-text">위치</span>
                      </button>
                    </div>
                    <button class="btn-post-submit">게시하기</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 정렬 옵션 -->
            <div class="sort-tabs">
              <button class="sort-tab active" data-sort="latest">최신순</button>
              <button class="sort-tab" data-sort="popular">인기순</button>
              <button class="sort-tab" data-sort="oldest">오래된순</button>
            </div>

            <!-- 게시글 목록 -->
<div class="posts-list" id="postsList"></div>

<!-- 비었을 때 표시 -->
<div id="postsEmpty" style="display:none; padding:16px; color:#777;">게시글이 없습니다.</div>

<!-- 로딩 표시(선택) -->
<div id="postsLoading" style="display:none; padding:16px;">불러오는 중...</div>

<!-- 카드 템플릿 -->
<template id="postCardTpl">
  <article class="post-card">
    <div class="post-header">
      <div class="author-info">
        <div class="author-avatar">
          <img src="/images/default-avatar.png" alt="프로필" class="avatar-img" />
        </div>
        <div class="author-details">
          <span class="author-name"></span>
          <span class="post-time"></span>
        </div>
      </div>
      <button class="post-menu-btn">⋯</button>
    </div>

    <div class="post-content">
      <p class="post-text"></p>
      <div class="post-images" hidden>
        <div class="image-grid"></div>
      </div>
    </div>

    <div class="post-actions">
      <button class="action-btn like-btn" data-liked="false">
        <span class="action-icon">❤️</span>
        <span class="action-text">좋아요 0</span>
      </button>
      <button class="action-btn comment-btn">
        <span class="action-icon">💬</span>
        <span class="action-text">댓글 0</span>
      </button>
      <button class="action-btn share-btn">
        <span class="action-icon">📤</span>
        <span class="action-text">공유</span>
      </button>
    </div>
  </article>
</template>

            <!-- 게시글 목록 -->
            <!-- <div class="posts-list"> -->
              <!-- 게시글 1 -->
              <!-- <article class="post-card">
                <div class="post-header">
                  <div class="author-info">
                    <div class="author-avatar">
                      <img
                        src="/images/default-avatar.png"
                        alt="프로필"
                        class="avatar-img"
                      />
                    </div>
                    <div class="author-details">
                      <span class="author-name">여행러버</span>
                      <span class="post-time">10분 전</span>
                    </div>
                  </div>
                  <button class="post-menu-btn">⋯</button>
                </div>

                <div class="post-content">
                  <p class="post-text">
                    오늘 설악산 다녀왔는데 정말 가을 풍경이 일품이더라고요!
                    특히나 계곡이 아직도 시원해서 더위가 가시지 않던 몸도
                    시원하게 식힐 수 있어서 좋더라구요. 다음주에 다시 갈
                    예정인데 혹시 함께 가실 분 계시나요? 🍂
                  </p>

                  <div class="post-images">
                    <div class="image-grid">
                      <div class="image-item">
                        <img
                          src="/images/sample1.jpg"
                          alt="여행 사진 1"
                          class="post-img"
                        />
                      </div>
                      <div class="image-item">
                        <img
                          src="/images/sample2.jpg"
                          alt="여행 사진 2"
                          class="post-img"
                        />
                      </div>
                      <div class="image-item">
                        <img
                          src="/images/sample3.jpg"
                          alt="여행 사진 3"
                          class="post-img"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="post-actions">
                  <button class="action-btn like-btn" data-liked="false">
                    <span class="action-icon">❤️</span>
                    <span class="action-text">좋아요 6</span>
                  </button>
                  <button class="action-btn comment-btn">
                    <span class="action-icon">💬</span>
                    <span class="action-text">댓글 20</span>
                  </button>
                  <button class="action-btn share-btn">
                    <span class="action-icon">📤</span>
                    <span class="action-text">공유</span>
                  </button>
                </div>
              </article> -->

              <!-- 게시글 2 -->
              <!-- <article class="post-card">
                <div class="post-header">
                  <div class="author-info">
                    <div class="author-avatar">
                      <img
                        src="/images/default-avatar.png"
                        alt="프로필"
                        class="avatar-img"
                      />
                    </div>
                    <div class="author-details">
                      <span class="author-name">산행매니아</span>
                      <span class="post-time">1시간 전</span>
                    </div>
                  </div>
                  <button class="post-menu-btn">⋯</button>
                </div>

                <div class="post-content">
                  <p class="post-text">
                    지리산 노고단 코스 다녀온 후기 공유드려요! 날씨가 좋아서
                    정말 멋진 산행이었습니다. 초보자분들도 무리 없이 오를 수
                    있는 코스라 추천드려요 👍
                  </p>
                </div>

                <div class="post-actions">
                  <button class="action-btn like-btn" data-liked="true">
                    <span class="action-icon">❤️</span>
                    <span class="action-text">좋아요 12</span>
                  </button>
                  <button class="action-btn comment-btn">
                    <span class="action-icon">💬</span>
                    <span class="action-text">댓글 8</span>
                  </button>
                  <button class="action-btn share-btn">
                    <span class="action-icon">📤</span>
                    <span class="action-text">공유</span>
                  </button>
                </div>
              </article>
            </div> -->

            <!-- 페이지네이션 -->
            <div class="pagination">
              <button class="page-btn prev" disabled>이전</button>
              <button class="page-btn active">1</button>
              <button class="page-btn">2</button>
              <button class="page-btn">3</button>
              <button class="page-btn next">다음</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 모달들 (기존 모달 구조 유지) -->
    <div id="memberListModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>전체 멤버</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <!-- 기존 멤버 리스트 모달 내용 -->
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div th:replace="footer :: footer"></div>
  </body>
  <script th:inline="javascript">
  window.currentUser = {
    username: /*[[${username}]]*/ ""
  };
  /* ===== 설정: 엔드포인트만 맞추면 됨 ===== */
const POSTS_ENDPOINT = '/community/all/posts'; // 예: GET /community/posts -> 배열 또는 {content:[...]}

/* ===== 유틸 ===== */
const isArr = Array.isArray;
function normalizeList(v) {
  if (v == null) return [];
  if (isArr(v)) return v.filter(Boolean);
  if (typeof v === 'string') {
    const s = v.trim();
    if (!s) return [];
    try { // JSON 문자열(["a","b"]) 가능성
      if ((s.startsWith('[') && s.endsWith(']')) || (s.startsWith('"') && s.endsWith('"'))) {
        return normalizeList(JSON.parse(s));
      }
    } catch(_) {}
    return s.split(',').map(x => x.trim()).filter(Boolean); // 콤마 구분
  }
  return [];
}
function timeAgo(iso) {
  if (!iso) return '';
  const now = new Date(), then = new Date(iso);
  const sec = Math.max(0, (now - then) / 1000);
  if (sec < 60) return '방금 전';
  const m = Math.floor(sec/60);   if (m < 60) return `${m}분 전`;
  const h = Math.floor(m/60);     if (h < 24) return `${h}시간 전`;
  const d = Math.floor(h/24);     if (d < 7) return `${d}일 전`;
  const w = Math.floor(d/7);      if (w < 5) return `${w}주 전`;
  const mo = Math.floor(d/30);    if (mo < 12) return `${mo}달 전`;
  const y = Math.floor(d/365);    return `${y}년 전`;
}
// 백엔드 필드명 다를 때 대응(원하는대로 수정 가능)
function adaptPost(p) {
  return {
    id:           p.id ?? p.postId ?? p.post_id,
    authorName:   p.username,
    avatarUrl:    p.avatarUrl ?? p.avatar_url ?? '/images/default-avatar.png',
    content:      p.content ?? p.postContent ?? p.text ?? '',
    pictures:     p.pictures ?? p.images ?? p.picturesJson ?? p.picturesCsv,
    likeCount:    p.likeCount ?? p.like_cnt ?? 0,
    commentCount: p.commentCount ?? p.comment_cnt ?? 0,
    liked:        !!(p.liked ?? p.isLiked),
    createdAt:    p.createdAt ?? p.reg_dt ?? p.created_at
  };
}

/* ===== 렌더 ===== */
function renderImages(root, pictures) {
  const pics = normalizeList(pictures);
  if (!pics.length) return;
  const imagesWrap = root.querySelector('.post-images');
  const grid = root.querySelector('.post-images .image-grid');
  imagesWrap.hidden = false;
  pics.slice(0, 9).forEach(src => {
    const item = document.createElement('div');
    item.className = 'image-item';
    const img = document.createElement('img');
    img.className = 'post-img';
    img.src = src;
    img.alt = '여행 사진';
    item.appendChild(img);
    grid.appendChild(item);
  });
}

function renderPostCard(post) {
  const tpl = document.getElementById('postCardTpl');
  const node = tpl.content.firstElementChild.cloneNode(true);

  // header
  node.querySelector('.author-name').textContent = post.authorName || '익명';
  node.querySelector('.post-time').textContent = timeAgo(post.createdAt);
  node.querySelector('.author-avatar img').src = post.avatarUrl || '/images/default-avatar.png';

  // content
  node.querySelector('.post-text').textContent = post.content || '';
  renderImages(node, post.pictures);

  // actions
  const likeBtn = node.querySelector('.like-btn');
  const likeText = node.querySelector('.like-btn .action-text');
  const commentText = node.querySelector('.comment-btn .action-text');

  likeBtn.dataset.liked = String(!!post.liked);
  likeText.textContent = `좋아요 ${post.likeCount ?? 0}`;
  commentText.textContent = `댓글 ${post.commentCount ?? 0}`;

  // 프론트에서만 토글(서버 호출 없음)
  likeBtn.addEventListener('click', () => {
    const was = likeBtn.dataset.liked === 'true';
    likeBtn.dataset.liked = String(!was);
    const cur = parseInt(likeText.textContent.replace(/\D/g,''), 10) || 0;
    likeText.textContent = `좋아요 ${was ? Math.max(0, cur-1) : cur+1}`;
  });

  return node;
}

function renderPosts(rows) {
  const listEl = document.getElementById('postsList');
  const emptyEl = document.getElementById('postsEmpty');
  listEl.innerHTML = '';

  if (!rows || !rows.length) {
    emptyEl.style.display = 'block';
    return;
  }
  emptyEl.style.display = 'none';

  const frag = document.createDocumentFragment();
  rows.forEach(raw => frag.appendChild(renderPostCard(adaptPost(raw))));
  listEl.appendChild(frag);
}

/* ===== 로딩/호출 ===== */
function setLoading(on) {
  document.getElementById('postsLoading').style.display = on ? 'block' : 'none';
}

async function loadPosts() {
  setLoading(true);
  const groupId = '1f2d3c4b-5a6e-4f80-9123-456789abcdef';
  try {
    const payload = {
      groupId: groupId,
    };

   const res = await fetch(POSTS_ENDPOINT, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify(payload)
  });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    // 배열 또는 페이지 객체(content 배열) 대응
    const rows = Array.isArray(data) ? data : (data.content || []);
    console.log("posts >>> " + JSON.stringify(data));
    renderPosts(rows);
  } catch (e) {
    console.error('게시글 로드 실패:', e);
    const emptyEl = document.getElementById('postsEmpty');
    emptyEl.textContent = '게시글을 불러오지 못했습니다.';
    emptyEl.style.display = 'block';
  } finally {
    setLoading(false);
  }
}

document.addEventListener('DOMContentLoaded', loadPosts);
</script>
</html>
