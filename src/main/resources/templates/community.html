<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>여기부터 - 커뮤니티</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/community.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/js/community.js"></script>
  </head>
  <body>
    <!-- Header -->
    <div th:replace="header :: header"></div>

    <section class="senior-community-section">
      <!-- 상단 커뮤니티 정보 헤더 -->
      <div class="community-header">
        <div class="container">
          <div class="community-info-card">
            <div class="community-banner">
              <img
                src="/images/travel-banner.jpg"
                alt="커뮤니티 배너"
                class="banner-image"
              />
              <div class="banner-overlay">
                <h1 class="community-title">
                  중년 여성들의 소박한 국내 여행 기록
                </h1>
                <p class="community-subtitle">함께하는 즐거운 여행 이야기</p>
              </div>
            </div>

            <div class="community-meta">
              <div class="meta-item">
                <span class="meta-icon">👥</span>
                <span class="meta-label">멤버</span>
                <span class="meta-value">16명</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon">📍</span>
                <span class="meta-label">지역</span>
                <span class="meta-value">서울</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon">📅</span>
                <span class="meta-label">일정</span>
                <span class="meta-value">2024.11.30~12.10</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon">👩</span>
                <span class="meta-label">대상</span>
                <span class="meta-value">여성만 (40~60대)</span>
              </div>
            </div>

            <div class="community-actions">
              <button class="btn-primary btn-large">
                <span class="btn-icon">👥</span>
                멤버 보기
              </button>
              <button class="btn-secondary btn-large">
                <span class="btn-icon">⚙️</span>
                설정
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 메인 컨텐츠 영역 -->
      <div class="container">
        <div class="main-layout">
          <!-- 왼쪽: 사이드바 -->
          <aside class="sidebar">
            <!-- 커뮤니티 상세 정보 -->
            <div class="sidebar-card">
              <h3 class="card-title">
                <span class="title-icon">ℹ️</span>
                모임 상세 정보
              </h3>
              <div class="info-list">
                <div class="info-item">
                  <span class="info-label">모임 이름</span>
                  <span class="info-value"
                    >중년 여성들의 소박한 국내 여행 기록</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">모임 성격</span>
                  <span class="info-value">국내여행</span>
                </div>
                <div class="info-item">
                  <span class="info-label">음성 채팅</span>
                  <span class="info-value badge-success">사용</span>
                </div>
              </div>

              <div class="description-box">
                <h4>모임 소개</h4>
                <p>
                  친근하고 자유로운 분위기로 30대 중반부터 60대 중후반까지의
                  다양한 연령대가 함께하는 모임입니다. 국내의 맛있는 음식들을
                  즐기고 서로 좋은 정보를 나누며 친목을 도모하는 것이
                  목표입니다.
                </p>
              </div>
            </div>

            <!-- 멤버 목록 -->
            <div class="sidebar-card">
              <div class="card-header-flex">
                <h3 class="card-title">
                  <span class="title-icon">👥</span>
                  모임 멤버 (<span id="sidebarMemCount">0</span>명)
                </h3>
                <button class="btn-text" id="viewAllMembers">전체보기</button>
              </div>

              <!-- 미리보기 컨테이너만 두고 JS로 채움 -->
              <div class="member-preview" id="memberPreview"></div>
            </div>

            <!-- 멤버 목록 -->
            <!-- <div class="sidebar-card">
              <div class="card-header-flex">
                <h3 class="card-title">
                  <span class="title-icon">👥</span>
                  모임 멤버 (16명)
                </h3>
                <button class="btn-text" id="viewAllMembers">전체보기</button>
              </div>

              <div class="member-preview">
                <div class="member-item">
                  <div class="member-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="멤버"
                      class="avatar-img"
                    />
                    <span class="member-status online"></span>
                  </div>
                  <div class="member-info">
                    <span class="member-name">멤버닉네임1</span>
                    <span class="member-role">리더</span>
                  </div>
                </div>

                <div class="member-item">
                  <div class="member-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="멤버"
                      class="avatar-img"
                    />
                    <span class="member-status online"></span>
                  </div>
                  <div class="member-info">
                    <span class="member-name">멤버닉네임2</span>
                    <span class="member-role">멤버</span>
                  </div>
                </div>

                <div class="member-item">
                  <div class="member-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="멤버"
                      class="avatar-img"
                    />
                    <span class="member-status"></span>
                  </div>
                  <div class="member-info">
                    <span class="member-name">멤버닉네임3</span>
                    <span class="member-role">멤버</span>
                  </div>
                </div>
              </div>
            </div> -->

            <!-- 빠른 링크 -->
            <div class="sidebar-card">
              <h3 class="card-title">
                <span class="title-icon">🔗</span>
                빠른 메뉴
              </h3>
              <div class="quick-links">
                <a href="#" class="quick-link-item">
                  <span class="link-icon">📋</span>
                  <span class="link-text">공지사항</span>
                </a>
                <a href="#" class="quick-link-item">
                  <span class="link-icon">📸</span>
                  <span class="link-text">사진첩</span>
                </a>
                <a href="#" class="quick-link-item">
                  <span class="link-icon">📅</span>
                  <span class="link-text">일정관리</span>
                </a>
                <a href="#" class="quick-link-item">
                  <span class="link-icon">💬</span>
                  <span class="link-text">채팅방</span>
                </a>
              </div>
            </div>
          </aside>
          <!-- 오른쪽: 게시글 영역 -->
          <div class="posts-section">
            <!-- 게시글 작성 카드 -->
            <div class="write-post-card">
              <div class="card-header">
                <h3>새 글 작성</h3>
                <div class="post-count">총 16개의 글</div>
              </div>

              <div class="write-form">
                <div class="author-info">
                  <div class="author-avatar">
                    <img
                      src="/images/default-avatar.png"
                      alt="프로필"
                      class="avatar-img"
                    />
                  </div>
                  <span class="author-name" th:text="${username != null ? username : '사용자님'}">현재로그인사람</span>
                  
                </div>

                <div class="write-content">
                  <textarea
                    class="write-textarea"
                    placeholder="여행 후기나 추천 장소를 공유해주세요! 사진도 함께 올려주시면 더 좋아요 😊"
                  ></textarea>

                  <!-- ✅ 썸네일 프리뷰가 나올 영역 -->
                 <div class="write-photo-preview" id="photoPreview"></div>

                  <div class="write-toolbar">
                    <div class="toolbar-left">
                      <button class="toolbar-btn" id="btnPhoto" title="사진 첨부">
                        <span class="btn-icon">📷</span>
                        <span class="btn-text">사진</span>
                      </button>
                    </div>
                    <button class="btn-post-submit">게시하기</button>
                  </div>
                </div>
                <!-- ✅ 숨겨진 이미지 선택 input -->
                <input id="photoInput" type="file" accept="image/*" multiple hidden>
              </div>
            </div>

            <!-- 정렬 옵션 -->
            <div class="sort-tabs">
              <button class="sort-tab active" data-sort="latest">최신순</button>
              <button class="sort-tab" data-sort="popular">인기순</button>
              <button class="sort-tab" data-sort="oldest">오래된순</button>
            </div>

            <!-- 게시글 목록 -->
            <div class="posts-list" id="postsList"></div>

            <!-- 비었을 때 표시 -->
            <div id="postsEmpty" style="display:none; padding:16px; color:#777;">게시글이 없습니다.</div>

            <!-- 로딩 표시(선택) -->
            <div id="postsLoading" style="display:none; padding:16px;">불러오는 중...</div>

            <!-- 카드 템플릿 -->
            <template id="postCardTpl">
              <article class="post-card">
                <div class="post-header">
                  <div class="author-info">
                    <div class="author-avatar">
                      <img src="/images/default-avatar.png" alt="프로필" class="avatar-img" />
                    </div>
                    <div class="author-details">
                      <span class="author-name"></span>
                      <span class="post-time"></span>
                    </div>
                  </div>
                  <button class="post-menu-btn">⋯</button>
                </div>

                <div class="post-content">
                  <p class="post-text"></p>
                  <div class="post-images" hidden>
                    <div class="image-grid"></div>
                  </div>
                </div>

                <div class="post-actions">
                  <button class="action-btn like-btn" data-liked="false">
                    <span class="action-icon">❤️</span>
                    <span class="action-text">좋아요 0</span>
                  </button>
                  <button class="action-btn comment-btn">
                    <span class="action-icon">💬</span>
                    <span class="action-text">댓글 0</span>
                  </button>
                  <button class="action-btn share-btn">
                    <span class="action-icon">📤</span>
                    <span class="action-text">공유</span>
                  </button>
                </div>
              </article>
            </template>

        

            <!-- 페이지네이션 -->
            <div class="pagination">
              <button class="page-btn prev" disabled>이전</button>
              <button class="page-btn active">1</button>
              <button class="page-btn">2</button>
              <button class="page-btn">3</button>
              <button class="page-btn next">다음</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 모달들 (기존 모달 구조 유지) -->
    <div id="memberListModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>전체 멤버</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <!-- 기존 멤버 리스트 모달 내용 -->
        </div>
      </div>
    </div>

    <!-- 이미지 라이트박스 -->
    <div id="imageLightbox" class="lb" hidden>
      <div class="lb-backdrop"></div>
      <div class="lb-dialog">
        <button class="lb-close" aria-label="닫기">×</button>
        <button class="lb-prev"  aria-label="이전">‹</button>
        <img id="lbImage" alt="첨부 이미지 미리보기">
        <button class="lb-next"  aria-label="다음">›</button>
        <div class="lb-counter"></div>
      </div>
    </div>

    <!-- Footer -->
    <div th:replace="footer :: footer"></div>
  </body>
  <script th:inline="javascript">
  window.currentUser = {
    username: /*[[${username}]]*/ ""
  };
  /* ===== 설정: 엔드포인트만 맞추면 됨 ===== */
const POSTS_ENDPOINT = '/community/all/posts'; // 예: GET /community/posts -> 배열 또는 {content:[...]}

/* ===== 유틸 ===== */
const isArr = Array.isArray;
function normalizeList(v) {
  if (v == null) return [];
  if (isArr(v)) return v.filter(Boolean);
  if (typeof v === 'string') {
    const s = v.trim();
    if (!s) return [];
    try { // JSON 문자열(["a","b"]) 가능성
      if ((s.startsWith('[') && s.endsWith(']')) || (s.startsWith('"') && s.endsWith('"'))) {
        return normalizeList(JSON.parse(s));
      }
    } catch(_) {}
    return s.split(',').map(x => x.trim()).filter(Boolean); // 콤마 구분
  }
  return [];
}
function timeAgo(iso) {
  if (!iso) return '';
  const now = new Date(), then = new Date(iso);
  const sec = Math.max(0, (now - then) / 1000);
  if (sec < 60) return '방금 전';
  const m = Math.floor(sec/60);   if (m < 60) return `${m}분 전`;
  const h = Math.floor(m/60);     if (h < 24) return `${h}시간 전`;
  const d = Math.floor(h/24);     if (d < 7) return `${d}일 전`;
  const w = Math.floor(d/7);      if (w < 5) return `${w}주 전`;
  const mo = Math.floor(d/30);    if (mo < 12) return `${mo}달 전`;
  const y = Math.floor(d/365);    return `${y}년 전`;
}
// 백엔드 필드명 다를 때 대응(원하는대로 수정 가능)
function adaptPost(p) {
  return {
    id:           p.id ?? p.postId ?? p.post_id,
    authorName:   p.username,
    avatarUrl:    p.avatarUrl ?? p.avatar_url ?? '/images/default-avatar.png',
    content:      p.content ?? p.postContent ?? p.text ?? '',
    pictures:     p.pictures ?? p.images ?? p.picturesJson ?? p.picturesCsv,
    likeCount:    p.likesCount,
    commentCount: p.commentCount ?? p.comment_cnt ?? 0,
    liked:        !!(p.liked ?? p.isLiked),
    createdAt:    p.createdAt ?? p.reg_dt ?? p.created_at
  };
}

/* ===== 렌더 ===== */
function renderImages(root, pictures) {
  const pics = normalizeList(pictures);
  const wrap = root.querySelector('.post-images');
  const grid = wrap.querySelector('.image-grid');
  grid.innerHTML = '';
  wrap.hidden = !pics.length;
  if (!pics.length) return;

  // ✅ 이 게시글의 전체 이미지 목록을 컨테이너에 보관
  wrap.dataset.urls = JSON.stringify(pics);

  pics.slice(0, 9).forEach((src, i) => {
    const item = document.createElement('div');
    item.className = 'image-item';
    const img = document.createElement('img');
    img.className = 'post-img';
    img.src = String(src).trim();
    img.alt = '여행 사진';
    img.loading = 'lazy';
    img.dataset.idx = i;                 // ✅ 클릭 시 시작 인덱스
    item.appendChild(img);

    if (i === 8 && pics.length > 9) {    // +N 오버레이(선택)
      const overlay = document.createElement('div');
      overlay.className = 'more-overlay';
      overlay.textContent = `+${pics.length - 9}`;
      item.appendChild(overlay);
    }
    grid.appendChild(item);
  });
}

function renderPostCard(post) {
  console.log("aaaa");
  const tpl = document.getElementById('postCardTpl');
  const node = tpl.content.firstElementChild.cloneNode(true);

  // header
  node.querySelector('.author-name').textContent = post.authorName || '익명';
  node.querySelector('.post-time').textContent = timeAgo(post.createdAt);
  node.querySelector('.author-avatar img').src = post.avatarUrl || '/images/default-avatar.png';

  // content
  node.querySelector('.post-text').textContent = post.content || '';
  node.dataset.postId = post.id;     // <article class="post-card" data-post-id="...">
  renderImages(node, post.pictures);

  // actions
  const likeBtn = node.querySelector('.like-btn');
  const likeText = node.querySelector('.like-btn .action-text');
  const commentText = node.querySelector('.comment-btn .action-text');

  likeBtn.dataset.count = String(post.likeCount);
// commentBtn.dataset.count = String(post.commentCount);

likeBtn.dataset.liked = String(!!post.liked);

  likeText.textContent = `좋아요 ${post.likeCount ?? 0}`;
  commentText.textContent = `댓글 ${post.commentCount ?? 0}`;

  // createdAt 문자열 -> ms로
const createdIso = (post.createdAt && typeof post.createdAt === 'string' && post.createdAt[10] === ' ')
  ? post.createdAt.replace(' ', 'T') : post.createdAt;
const createdMs = toMillis(createdIso);

node.querySelector('.post-time').textContent = timeAgo(createdIso);
node.dataset.created = String(createdMs);   // ✅ 정렬용 키 저장

// ✅ 서버에서 사용자별 좋아요 상태/최신 카운트 조회해 덮어쓰기
  hydrateLikeState(node, post.id);

  return node;
}

function applyLikeDesign(cardEl) {
  const btn  = cardEl.querySelector('.like-btn');
  if (!btn) return;

  const text = btn.querySelector('.action-text');

  // UI
  btn.classList.toggleClass('liked', nextLiked)
      .attr('aria-pressed', String(nextLiked));

  if (text) text.textContent = `좋아요 ${count}`;
  btn.classList.toggle('liked', !!liked);
  btn.setAttribute('aria-pressed', String(!!liked));
}

function hydrateLikeState(cardEl, postId) {
  const payload = {
    username: window.currentUser.username,
    postId: postId
  };

  $.ajax({
    url: "/community/post/likeInfo",     // ← 네 엔드포인트
    type: "POST",
    data: JSON.stringify(payload),
    contentType: "application/json",
    success: function (resp) {
      if(resp){
        console.log("resp >>> " + resp);
         const btn  = cardEl.querySelector('.like-btn');
         const $btn = $(btn);
          // UI
          $btn.toggleClass('liked', resp)
        .attr('aria-pressed', String(resp));
        btn.dataset.liked = String(resp);
          // addHeartAnimation($btn);
      }
    },
    error: function (req, status, err) {
      console.error("좋아요 상태 조회 실패:", err);
      // 실패 시엔 초기값(게시글 목록의 값) 유지
    }
  });
}

function renderPosts(rows) {
  const listEl = document.getElementById('postsList');
  const emptyEl = document.getElementById('postsEmpty');
  listEl.innerHTML = '';

  if (!rows || !rows.length) {
    emptyEl.style.display = 'block';
    return;
  }
  emptyEl.style.display = 'none';

  const frag = document.createDocumentFragment();
  rows.forEach(raw => frag.appendChild(renderPostCard(adaptPost(raw))));
  listEl.appendChild(frag);
}

/* ===== 로딩/호출 ===== */
function setLoading(on) {
  document.getElementById('postsLoading').style.display = on ? 'block' : 'none';
}

async function loadPosts() {
  setLoading(true);
  const groupId = '1f2d3c4b-5a6e-4f80-9123-456789abcdef';
  try {
    const payload = {
      groupId: groupId,
    };

   const res = await fetch(POSTS_ENDPOINT, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify(payload)
  });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    // 배열 또는 페이지 객체(content 배열) 대응
    const rows = Array.isArray(data) ? data : (data.content || []);
    // ✅ 최신순(내림차순) 정렬: createdAt / created_at / reg_dt 우선 사용
    const sorted = [...rows].sort((a, b) => {
      const aT = toMillis(a.createdAt ?? a.created_at ?? a.reg_dt);
      const bT = toMillis(b.createdAt ?? b.created_at ?? b.reg_dt);
      return bT - aT;
    });
    console.log("posts >>> " + JSON.stringify(data));
    renderPosts(sorted);
  } catch (e) {
    console.error('게시글 로드 실패:', e);
    const emptyEl = document.getElementById('postsEmpty');
    emptyEl.textContent = '게시글을 불러오지 못했습니다.';
    emptyEl.style.display = 'block';
  } finally {
    setLoading(false);
  }
}

document.addEventListener('DOMContentLoaded', loadPosts);

(function(){
  const lb = document.getElementById('imageLightbox');
  const imgEl = lb.querySelector('#lbImage');
  const counterEl = lb.querySelector('.lb-counter');
  const btnClose = lb.querySelector('.lb-close');
  const btnPrev  = lb.querySelector('.lb-prev');
  const btnNext  = lb.querySelector('.lb-next');
  const backdrop = lb.querySelector('.lb-backdrop');

  let urls = [];
  let idx = 0;

  function refresh() {
    imgEl.src = urls[idx] || '';
    counterEl.textContent = `${idx+1}/${urls.length}`;
    const many = urls.length > 1;
    btnPrev.style.display = many ? 'flex' : 'none';
    btnNext.style.display = many ? 'flex' : 'none';
    counterEl.style.display = many ? 'block' : 'none';
  }

  function openLightbox(arr, startIdx){
    urls = Array.isArray(arr) ? arr : [];
    idx = Math.max(0, Math.min(startIdx|0, urls.length-1));
    if (!urls.length) return;
    refresh();
    lb.hidden = false;
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox(){
    lb.hidden = true;
    document.body.style.overflow = '';
    urls = []; idx = 0; imgEl.removeAttribute('src');
  }

  function showNext(delta){
    if (!urls.length) return;
    idx = (idx + delta + urls.length) % urls.length;
    refresh();
  }

  // 버튼/백드롭/키보드
  btnClose.addEventListener('click', closeLightbox);
  backdrop.addEventListener('click', closeLightbox);
  btnPrev .addEventListener('click', () => showNext(-1));
  btnNext .addEventListener('click', () => showNext(+1));
  document.addEventListener('keydown', (e)=>{
    if (lb.hidden) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft')  showNext(-1);
    if (e.key === 'ArrowRight') showNext(+1);
  });

  // ✅ 델리게이션: 어떤 게시글의 썸네일이든 클릭 시 열기
  document.addEventListener('click', (e)=>{
    const img = e.target.closest('.post-images .post-img');
    if (!img) return;
    const wrap = img.closest('.post-images');
    let arr = [];
    try { arr = JSON.parse(wrap.dataset.urls || '[]'); } catch(_) {
      arr = Array.from(wrap.querySelectorAll('.post-img')).map(x=>x.src);
    }
    const startIdx = parseInt(img.dataset.idx || '0', 10);
    openLightbox(arr, startIdx);
  });
})();
</script>
</html>
